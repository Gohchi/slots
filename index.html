<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
    <script type="text/javascript" src="lib/api.js"></script>
</head>
<body>

    <script>
    var gameWidth = 490;
    var gameHeight = 570;
    var baseText = 'WIN: $';
    var xOutsideOffset = -500;
    var yOutsideOffset = -30;
    
    var config = {
        type: Phaser.AUTO,
        width: gameWidth,
        height: gameHeight,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 200 }
            }
        },
        scene: {
            preload: preload,
            create: create
        }
    };

    var game = new Phaser.Game(config);

    function preload ()
    {
      this.load.setBaseURL('http://localhost:8080');

      this.load.image('bg', 'img/frame.png');
      this.load.image('prize', 'img/prize_window.png');
      this.load.image('spin', 'img/btn_spin.png');
      this.load.image('line1', 'img/line_1.png');
      this.load.image('line4', 'img/line_4.png');
      this.load.image('line5', 'img/line_5.png');
      
      this.load.image('a', 'img/symbols/sym_a.png');
      this.load.image('b', 'img/symbols/sym_b.png');
      this.load.image('c', 'img/symbols/sym_c.png');
      this.load.image('d', 'img/symbols/sym_d.png');
      this.load.image('e', 'img/symbols/sym_e.png');
    }

    function create ()
    {
      var lines = [];
      var centerX = gameWidth / 2;

      var bg = this.add.image(0, 0, 'bg');
      bg.setPosition(gameWidth / 2, bg.height / 2);

      var frameContentMargin = 25;
      var frameContentSize = bg.height - frameContentMargin * 2;
      var frameContentSizeFix = frameContentSize / 3 / 2;

      var reelInfoList = wrapper.getReels();
      var reels = [[], [], []];
      for (var i in reelInfoList) {
        var i = parseInt(i);
        reelInfoList[i].forEach((function (reelInfo, l) {
          reels[i].push(this.add.image(xOutsideOffset + 140 * (i + 1) - 35, -25 + 140 * (l + 1) - 35, reelInfo));
        }).bind(this));
      };
      // console.log(reels);
      
      this.cameras.add(30, 30, 430, 430).setScroll(-470, 0);

      this.add.image(100, gameHeight - 40, 'prize');
      var prizeText = this.add.text(100, gameHeight - 40, baseText + '0', {
        fill: '#1b3768',
        fontFamily: 'Arial',
        fontSize: '20px',
        fontStyle: 'bold',
        align: 'center'
      }).setOrigin(0.5);
      setButtonStyle(this.add.image(gameWidth - 100, gameHeight - 40, 'spin'))
        .on('pointerdown', () => {
          lines.forEach(function (line){
            line.destroy();
          });
          lines = [];
        })
        .on('pointerup', () => {
          var results = wrapper.spin(); 
          console.log(results);
          results.prizes.forEach((function (prize) {
            console.log(prize.lineId);
            switch(prize.lineId){
              case 0:
                lines.push(this.add.image(centerX + xOutsideOffset, yOutsideOffset + frameContentMargin + frameContentSize / 3 - frameContentSizeFix, 'line1'));
                break;
              case 1:
                lines.push(this.add.image(centerX + xOutsideOffset, yOutsideOffset + frameContentMargin + frameContentSize / 3 * 2- frameContentSizeFix, 'line1'));
                break;
              case 2:
                lines.push(this.add.image(centerX + xOutsideOffset, yOutsideOffset + frameContentMargin + frameContentSize - frameContentSizeFix, 'line1'));
                break;
              case 3:
                lines.push(this.add.image(centerX + xOutsideOffset, yOutsideOffset + bg.height / 2, 'line4'));
                break;
              case 4:
                lines.push(this.add.image(centerX + xOutsideOffset, yOutsideOffset + bg.height / 2, 'line5'));
                break;
            }
          }).bind(this));
          prizeText.setText(baseText + results.winnings.toString());
         });
    }
    function setButtonStyle(button){
      button
        .setInteractive()
        .on('pointerover', () => { button.tint = 0xdddddd; })
        .on('pointerout', () => { button.tint = 0xffffff; })
        .on('pointerdown', () => { button.tint = 0x888888; })
        .on('pointerup', () => { button.tint = 0xffffff; });
      return button;
    }
    </script>

</body>
</html>